<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "mybatis-3-mapper.dtd">
<mapper namespace="sellermobile.counsel">

    <select id="counselList" resultType="DevMap" parameterType="DevMap">
        select T.CALL_ST_CD,
        t1.MNT_CARR,
        t1.PN_REG_DIS as PN_REG_DIS_CD,
        (SELECT CD_NM FROM TBL_CMMN_CD tcc WHERE tcc.CD_VAL = t1.PN_REG_DIS) as PN_REG_DIS,
        (select PN_MNT_RT_NM FROM TBL010 tt1 where tt1.PN_MNT_RT_NO = t1.PN_MNT_RT_NO) as PN_MNT_RT_NM,
        (select PN_NET_TYPE FROM TBL010 tt1 where tt1.PN_MNT_RT_NO = t1.PN_MNT_RT_NO) as PN_NET_TYPE,
        t1.PN_MNT_RT_NO,
        t1.PN_MDL_NO,
        (select DISTINCT PN_MDL_NM FROM TBL011 tt2 where tt2.PN_MDL_NO = t1.PN_MDL_NO) as PN_MDL_NM,
        t1.PN_STOR,
        (select PN_MSRP FROM TBL011 tt4 where tt4.PN_MDL_NO = t1.PN_MDL_NO and tt4.PN_STOR = t1.PN_STOR) as PN_MSRP,
        (SELECT t.PN_IMG FROM TBL011 t WHERE t.PN_MDL_NO =t1.PN_MDL_NO GROUP BY t.PN_MDL_NO) as PN_IMG,
        (SELECT MBR_NM FROM TBL001 tt3 where tt3.CL_MBR_ID = t1.CL_MBR_ID) as CL_MBR_NM,
        t1.CL_MBR_ID,   /* 고객ID */
        T.MBR_PN_NO as CL_MBR_PN_NO,    /* 고객연락처 */
        (SELECT EXISTS (SELECT * FROM `TBL005-B` tb WHERE tb.DEAL_NO = T.DEAL_NO)) as BLK_YN,
        (SELECT DISTINCT PN_MKR FROM TBL011 pnmkr where pnmkr.PN_MDL_NO = t1.PN_MDL_NO) as PN_MKR,
        DATE_FORMAT(T.VISIT_DT, '%Y-%m-%d %H:%i') as VISIT_DT,
        t1.DEAL_REQ,    /* 고객요청내용 */
        T.OLD_OFCL_SUBSD,
        T.OLD_EXT_SUBSD_DV,
        T.OLD_EXT_SUBSD_RT,
        T.OLD_EXT_SERV_YN,
        T.CALL_NO,
        T.CALL_CONT,    /* 상담내용 */
        T.DEAL_CONT,    /* 상담결과 */
        T.CNCL_CMNT,    /* 취소사유 */
        T.BN_MBR_ID,    /* 업체상담직원아이디 */
        (SELECT MBR_NM FROM TBL002 tt5 WHERE tt5.BN_MBR_ID = T.BN_MBR_ID) as BN_MBR_NM, /* 업체상담직원이름 */
        T.REG_PD, /* 개통한 약정기간 */
        T.REG_TYPE, /* 개통한 가입유형 */
        T.REG_MBR_PN_NO, /* 개통한 번호 */
        T.REG_MNT_RT_NO, /* 개통한 요금제 */
        (select PN_MNT_RT_NM FROM TBL010 tt9 where tt9.PN_MNT_RT_NO = T.REG_MNT_RT_NO) as REG_MNT_RT_NM,
        T.REG_CARR, /* 개통한 통신사 */
        (SELECT DISTINCT PN_MKR FROM TBL011 pnmkr where pnmkr.PN_MDL_NO = T.REG_PN_MDL_NO) as REG_PN_MKR, /* 개통한 모델제조사
        */
        T.REG_PN_MDL_NO, /* 개통한 모델 */
        T.REG_PN_STOR, /* 개통한 모델 용량 */
        (select DISTINCT PN_MDL_NM FROM TBL011 tt2 where tt2.PN_MDL_NO = T.REG_PN_MDL_NO) as REG_PN_MDL_NM, /* 개통한 모델이름
        */
        T.REG_EXT_SERV_YN, /* 개통시 부가서비스여부 */
        DATE_FORMAT(T.INP_DT, '%Y-%m-%d %H:%i') as INP_DT,
        DATE_FORMAT(T.AMD_DT, '%Y-%m-%d %H:%i') as AMD_DT
        from TBL008 T left join TBL006 t1 on T.DEAL_NO = t1.DEAL_NO
        WHERE T.BN_NO = (SELECT cf_get_bn_no(#{loginMbrId}))
        <if test='searchKwd != ""'>
            <choose>
                <when test="selectOpt == 'clientNm'">
                    AND (SELECT MBR_NM FROM TBL001 tt5 where tt5.CL_MBR_ID = t1.CL_MBR_ID) LIKE CONCAT('%', #{searchKwd}, '%')
                </when>
                <when test="selectOpt == 'clientNum'">
                    AND T.MBR_PN_NO LIKE CONCAT('%', #{searchKwd}, '%')
                </when>
            </choose>
        </if>
        ORDER BY AMD_DT desc
    </select>

    <select id="currPolicy" parameterType="DevMap" resultType="DevMap">
        select (select PN_MSRP FROM TBL011 tt1 where tt1.PN_MDL_NO = T.PN_MDL_NO and tt1.PN_STOR = T.PN_STOR) as
        PN_MSRP,
        T.SELL_YN,
        T.PN_OFCL_SUBSD,
        T.PN_EXT_SUBSD_DV,
        T.PN_EXT_SUBSD_RT,
        T.PN_EXT_SERV_YN
        <choose>
            <when test='pnRegDis == "A"'>
                from `TBL007-A` T
            </when>
            <when test='pnRegDis == "B"'>
                from `TBL007-B` T
            </when>
            <when test='pnRegDis == "C"'>
                from `TBL007-C` T
            </when>
        </choose>
        where PN_MDL_NO = #{pnMdlNo}
        and PN_STOR = #{pnStor}
        and PN_MNT_RT_NO = #{pnMntRtNo}
        and BN_NO = (SELECT cf_get_bn_no(#{loginMbrId}))
    </select>


    <select id="selectDevice" resultType="DevMap" parameterType="DevMap">
        SELECT *,
        CONCAT(t.PN_MDL_NM," ", t.PN_STOR, "GB") as label
        FROM TBL011 t
        WHERE t.PN_CARR LIKE CONCAT('%' #{pnCarr}, '%')
        AND t.PN_MKR = #{pnMkr}
        group by t.PN_MDL_NO, t.PN_STOR
        order by t.REL_DT desc, t.PN_MDL_NO, convert(t.PN_STOR, decimal), convert(t.PN_MSRP, decimal) desc
    </select>

    <select id="blackYnChk" parameterType="DevMap" resultType="DevMap">
        select count(*) as cnt from `TBL005-B` tb
        where CL_MBR_ID =#{clMbrId}
        and DEAL_NO = (select t.DEAL_NO from TBL008 t where t.CALL_NO = #{callNo})
    </select>

</mapper>